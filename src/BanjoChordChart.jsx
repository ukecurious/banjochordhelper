import { useState, useMemo, useCallback, useRef } from "react";

// ─── Constants ───────────────────────────────────────────────────────────────

const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

const ENHARMONIC_MAP = {
  'Db': 'C#', 'Eb': 'D#', 'Fb': 'E', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#', 'Cb': 'B',
  'E#': 'F', 'B#': 'C',
};

const COMMON_TUNINGS = {
  'Open G (Standard)': ['G', 'D', 'G', 'B', 'D'],
  'Double C': ['G', 'C', 'G', 'C', 'D'],
  'Old-Time D': ['A', 'D', 'A', 'D', 'E'],
  'Open D': ['A', 'D', 'F#', 'A', 'D'],
  'Double D': ['A', 'D', 'A', 'D', 'F#'],
  'Open C': ['G', 'C', 'G', 'C', 'E'],
  'G Modal (Sawmill)': ['G', 'D', 'G', 'C', 'D'],
  'Open A': ['A', 'E', 'A', 'C#', 'E'],
};

const CHORD_TYPES = [
  { name: 'Major', suffix: '' },
  { name: 'Minor', suffix: 'm' },
  { name: 'Seventh', suffix: '7' },
  { name: 'Minor Seventh', suffix: 'm7' },
  { name: 'Sixth', suffix: '6' },
  { name: 'Augmented', suffix: 'aug' },
  { name: 'Diminished', suffix: 'dim' },
];

// ─── Curated Open G Library ─────────────────────────────────────────────────
// Format: [4th string fret, 3rd string fret, 2nd string fret, 1st string fret]
// -1 = muted

const OPEN_G_LIBRARY = {
  // Major chords
  'C':   [[2, 0, 1, 2], [2, 0, 1, 5], [5, 0, 1, 2]],
  'C#':  [[3, 1, 2, 3], [6, 6, 2, 3]],
  'D':   [[0, 2, 3, 4], [4, 2, 3, 0], [4, 2, 3, 4]],
  'D#':  [[1, 3, 4, 5], [5, 3, 4, 1]],
  'E':   [[2, 1, 0, 2], [2, 4, 0, 6]],
  'F':   [[3, 2, 1, 3]],
  'F#':  [[4, 3, 2, 4]],
  'G':   [[0, 0, 0, 0], [0, 0, 0, 5], [5, 0, 0, 0]],
  'G#':  [[1, 1, 1, 1]],
  'A':   [[2, 2, 2, 2]],
  'A#':  [[0, 3, 3, 3], [3, 3, 3, 0]],
  'B':   [[1, 4, 0, 4], [4, 4, 0, 1], [1, 4, 4, 4]],

  // Minor chords
  'Cm':  [[1, 0, 1, 1], [1, 0, 1, 5], [5, 0, 1, 1]],
  'C#m': [[2, 1, 2, 2]],
  'Dm':  [[0, 2, 3, 3], [3, 2, 3, 0]],
  'D#m': [[1, 3, 4, 4], [4, 3, 4, 1]],
  'Em':  [[2, 0, 0, 2], [2, 0, 0, 5], [5, 0, 0, 2]],
  'Fm':  [[3, 1, 1, 3]],
  'F#m': [[4, 2, 2, 4]],
  'Gm':  [[0, 3, 3, 5], [5, 3, 3, 0], [5, 3, 3, 5]],
  'G#m': [[1, 1, 0, 1]],
  'Am':  [[2, 2, 1, 2]],
  'A#m': [[3, 3, 2, 3]],
  'Bm':  [[0, 4, 0, 4], [4, 4, 0, 0], [0, 4, 3, 4]],

  // Seventh chords
  'C7':  [[2, 3, 1, 5], [5, 3, 1, 2]],
  'C#7': [[3, 4, 2, 6], [6, 4, 2, 3]],
  'D7':  [[0, 2, 1, 4], [4, 2, 1, 0]],
  'D#7': [[1, 3, 2, 5], [5, 3, 2, 1]],
  'E7':  [[0, 1, 0, 2], [2, 1, 0, 0]],
  'F7':  [[1, 2, 1, 3], [3, 2, 1, 1]],
  'F#7': [[2, 3, 2, 4], [4, 3, 2, 2]],
  'G7':  [[0, 0, 0, 3], [3, 0, 0, 0]],
  'G#7': [[1, 1, 1, 4], [4, 1, 1, 1]],
  'A7':  [[2, 2, 2, 5], [5, 2, 2, 2]],
  'A#7': [[3, 3, 3, 6], [6, 3, 3, 3]],
  'B7':  [[1, 2, 0, 4], [4, 2, 0, 1]],

  // Minor Seventh chords
  'Cm7': [[1, 3, 1, 5], [5, 3, 1, 1]],
  'C#m7':[[2, 4, 2, 6], [6, 4, 2, 2]],
  'Dm7': [[0, 2, 1, 3], [3, 2, 1, 0]],
  'D#m7':[[1, 3, 2, 4], [4, 3, 2, 1]],
  'Em7': [[0, 0, 0, 2], [2, 0, 0, 0]],
  'Fm7': [[1, 1, 1, 3], [3, 1, 1, 1]],
  'F#m7':[[2, 2, 2, 4], [4, 2, 2, 2]],
  'Gm7': [[3, 3, 3, 5], [5, 3, 3, 3], [0, 3, 6, 5]],
  'G#m7':[[1, 1, 0, 4], [4, 1, 0, 1]],
  'Am7': [[2, 2, 1, 5], [5, 2, 1, 2]],
  'A#m7':[[3, 3, 2, 6], [6, 3, 2, 3]],
  'Bm7': [[0, 2, 0, 4], [4, 2, 0, 0]],

  // Sixth chords
  'C6':  [[2, 2, 1, 5], [5, 2, 1, 2]],
  'C#6': [[3, 3, 2, 6], [6, 3, 2, 3]],
  'D6':  [[0, 2, 0, 4], [4, 2, 0, 0]],
  'D#6': [[1, 3, 1, 5], [5, 3, 1, 1]],
  'E6':  [[2, 4, 2, 6], [6, 4, 2, 2]],
  'F6':  [[0, 2, 1, 3], [3, 2, 1, 0]],
  'F#6': [[1, 3, 2, 4], [4, 3, 2, 1]],
  'G6':  [[0, 0, 0, 2], [2, 0, 0, 0]],
  'G#6': [[1, 1, 1, 3], [3, 1, 1, 1]],
  'A6':  [[2, 2, 2, 4], [4, 2, 2, 2]],
  'A#6': [[0, 3, 6, 5], [3, 3, 6, 8]],
  'B6':  [[1, 1, 0, 4], [4, 1, 0, 1]],

  // Augmented chords
  'Caug':  [[2, 1, 1, 2]],
  'C#aug': [[3, 2, 2, 3]],
  'Daug':  [[0, 3, 3, 4], [4, 3, 3, 0]],
  'D#aug': [[1, 0, 0, 1], [1, 0, 0, 5]],
  'Eaug':  [[2, 1, 1, 2]],
  'Faug':  [[3, 2, 2, 3]],
  'F#aug': [[0, 3, 3, 4], [4, 3, 3, 0]],
  'Gaug':  [[1, 0, 0, 1], [1, 0, 0, 5]],
  'G#aug': [[2, 1, 1, 2]],
  'Aaug':  [[3, 2, 2, 3]],
  'A#aug': [[0, 3, 3, 4], [4, 3, 3, 0]],
  'Baug':  [[1, 0, 0, 1], [1, 0, 0, 5]],

  // Diminished chords
  'Cdim':  [[1, 5, 1, 4], [4, 5, 1, 1]],
  'C#dim': [[2, 0, 2, 2], [2, 0, 2, 5]],
  'Ddim':  [[0, 1, 3, 3], [3, 1, 3, 0]],
  'D#dim': [[1, 2, 4, 4], [4, 2, 4, 1]],
  'Edim':  [[2, 3, 5, 5], [5, 3, 5, 2]],
  'Fdim':  [[3, 1, 0, 3], [3, 4, 0, 6]],
  'F#dim': [[4, 2, 1, 4]],
  'Gdim':  [[5, 3, 2, 5]],
  'G#dim': [[0, 1, 0, 0], [0, 4, 0, 6]],
  'Adim':  [[1, 2, 1, 1]],
  'A#dim': [[2, 3, 2, 2]],
  'Bdim':  [[0, 4, 0, 3], [3, 4, 0, 0]],
};

// ─── Preset Libraries for Common Tunings ─────────────────────────────────────
// Every voicing verified by exhaustive brute-force search.
// Format same as OPEN_G_LIBRARY: chordName → array of voicings

const PRESET_LIBRARIES = {

// Double C: G-C-G-C-D
// Strings shown: C-G-C-D
  'Double C': {
    'C': [[0,0,0,2], [0,0,4,2], [4,0,0,2]],
    'C#': [[1,1,1,3], [1,1,5,3], [5,1,1,3]],
    'D': [[2,2,2,4], [2,2,6,0], [6,2,2,0]],
    'D#': [[3,3,3,5], [3,0,3,1], [3,3,7,5]],
    'E': [[4,4,4,6], [4,4,8,6], [8,4,4,6]],
    'F': [[0,2,0,3], [0,2,5,3], [5,2,0,3]],
    'F#': [[1,3,1,4], [-1,3,1,4], [1,3,-1,4]],
    'G': [[2,4,2,5], [7,4,7,0], [-1,4,7,0]],
    'G#': [[0,1,0,1], [0,1,3,1], [3,1,0,1]],
    'A': [[1,2,1,2], [1,2,4,2], [4,2,1,2]],
    'A#': [[2,3,2,3], [2,3,5,0], [5,3,2,0]],
    'B': [[3,4,3,4], [3,4,6,4], [6,4,3,4]],
    'Cm': [[0,0,0,1], [0,0,3,1], [3,0,0,1]],
    'C#m': [[1,1,1,2], [1,1,4,2], [4,1,1,2]],
    'Dm': [[2,2,2,3], [2,2,5,0], [5,2,2,0]],
    'D#m': [[3,3,3,4], [3,3,6,4], [6,3,3,4]],
    'Em': [[4,4,4,5], [4,0,4,2], [4,4,7,5]],
    'Fm': [[0,1,0,3], [0,1,5,3], [5,1,0,3]],
    'F#m': [[1,2,1,4], [-1,2,1,4], [1,2,-1,4]],
    'Gm': [[2,3,2,5], [7,0,10,0], [10,0,7,0]],
    'G#m': [[3,4,3,6], [-1,4,3,6], [3,4,-1,6]],
    'Am': [[0,2,0,2], [0,2,4,2], [4,2,0,2]],
    'A#m': [[1,3,1,3], [1,3,5,3], [5,3,1,3]],
    'Bm': [[2,4,2,4], [2,4,6,0], [6,4,2,0]],
    'C7': [[0,0,4,8], [4,0,0,8], [0,3,4,5]],
    'C#7': [[5,6,8,9], [8,6,5,9]],
    'D7': [[0,2,2,4], [0,2,6,0], [2,2,0,4]],
    'D#7': [[1,3,3,5], [3,3,1,5]],
    'E7': [[4,4,8,0], [8,4,4,0], [2,4,4,6]],
    'F7': [[0,2,3,3], [3,2,0,3], [0,2,5,1]],
    'F#7': [[1,3,4,4], [4,3,1,4], [4,6,6,8]],
    'G7': [[5,4,7,0], [7,4,5,0], [2,4,5,5]],
    'G#7': [[0,1,3,4], [3,1,0,4], [0,8,8,4]],
    'A7': [[1,2,4,5], [4,2,1,5], [4,6,7,7]],
    'A#7': [[2,3,5,6], [5,3,2,6], [8,10,10,0]],
    'B7': [[3,4,6,7], [6,4,3,7], [6,8,9,9]],
    'Cm7': [[0,3,3,5], [3,3,0,5], [0,8,7,8]],
    'Dm7': [[0,2,2,3], [0,2,5,0], [2,2,0,3]],
    'D#m7': [[1,3,3,4], [3,3,1,4]],
    'Em7': [[4,4,7,0], [7,4,4,0], [2,4,4,5]],
    'Fm7': [[0,1,3,3], [3,1,0,3], [0,1,5,1]],
    'F#m7': [[1,2,4,4], [4,2,1,4], [4,6,6,7]],
    'Gm7': [[5,3,7,0], [7,3,5,0], [2,3,5,5]],
    'G#m7': [[3,4,6,6], [6,4,3,6], [6,8,8,9]],
    'Am7': [[0,0,4,7], [4,0,0,7], [0,2,4,5]],
    'A#m7': [[5,6,8,8], [8,6,5,8]],
    'Bm7': [[6,7,9,9], [9,7,6,9]],
    'C6': [[0,0,4,7], [4,0,0,7], [0,2,4,5]],
    'C#6': [[5,6,8,8], [8,6,5,8]],
    'D6': [[6,7,9,9], [9,7,6,9]],
    'D#6': [[0,3,3,5], [3,3,0,5], [0,8,7,8]],
    'F6': [[0,2,2,3], [0,2,5,0], [2,2,0,3]],
    'F#6': [[1,3,3,4], [3,3,1,4]],
    'G6': [[4,4,7,0], [7,4,4,0], [2,4,4,5]],
    'G#6': [[0,1,3,3], [3,1,0,3], [0,1,5,1]],
    'A6': [[1,2,4,4], [4,2,1,4], [4,6,6,7]],
    'A#6': [[5,3,7,0], [7,3,5,0], [2,3,5,5]],
    'B6': [[3,4,6,6], [6,4,3,6], [6,8,8,9]],
    'Caug': [[0,1,0,2], [0,1,4,2], [4,1,0,2]],
    'C#aug': [[1,2,1,3], [1,2,5,3], [5,2,1,3]],
    'Daug': [[2,3,2,4], [2,3,6,0], [6,3,2,0]],
    'D#aug': [[3,4,3,5], [3,0,3,1], [3,4,7,5]],
    'Eaug': [[0,1,0,2], [0,1,4,2], [4,1,0,2]],
    'Faug': [[1,2,1,3], [1,2,5,3], [5,2,1,3]],
    'F#aug': [[2,3,2,4], [2,3,6,0], [6,3,2,0]],
    'Gaug': [[3,4,3,5], [3,4,7,5], [7,4,3,5]],
    'G#aug': [[0,1,0,2], [0,1,4,2], [4,1,0,2]],
    'Aaug': [[1,2,1,3], [1,2,5,3], [5,2,1,3]],
    'A#aug': [[2,3,2,4], [2,3,6,0], [6,3,2,0]],
    'Baug': [[3,4,3,5], [3,4,7,5], [7,4,3,5]],
    'Cdim': [[0,8,0,4], [0,5,3,4], [3,5,0,4]],
    'C#dim': [[1,0,1,2], [1,0,4,2], [4,0,1,2]],
    'Ddim': [[2,1,2,3], [2,1,5,0], [5,1,2,0]],
    'D#dim': [[3,2,3,4], [3,2,6,4], [6,2,3,4]],
    'Edim': [[4,0,4,8], [4,3,4,5], [4,0,7,8]],
    'Fdim': [[5,4,5,6], [5,4,8,6], [8,4,5,6]],
    'F#dim': [[0,2,0,4], [0,2,6,4], [6,2,0,4]],
    'Gdim': [[1,3,1,5], [-1,3,1,5], [1,3,-1,5]],
    'G#dim': [[2,4,2,6], [8,4,8,0], [-1,4,8,0]],
    'Adim': [[0,2,0,1], [0,2,3,1], [3,2,0,1]],
    'A#dim': [[1,3,1,2], [1,3,4,2], [4,3,1,2]],
    'Bdim': [[2,4,2,3], [2,4,5,0], [5,4,2,0]],
  },

// Old-Time D: A-D-A-D-E
// Strings shown: D-A-D-E
  'Old-Time D': {
    'C': [[2,3,2,3], [2,3,5,0], [5,3,2,0]],
    'C#': [[3,4,3,4], [3,4,6,4], [6,4,3,4]],
    'D': [[0,0,0,2], [0,0,4,2], [4,0,0,2]],
    'D#': [[1,1,1,3], [1,1,5,3], [5,1,1,3]],
    'E': [[2,2,2,4], [2,2,6,0], [6,2,2,0]],
    'F': [[3,3,3,5], [3,0,3,1], [3,3,7,5]],
    'F#': [[4,4,4,6], [4,4,8,6], [8,4,4,6]],
    'G': [[0,2,0,3], [0,2,5,3], [5,2,0,3]],
    'G#': [[1,3,1,4], [-1,3,1,4], [1,3,-1,4]],
    'A': [[2,4,2,5], [7,4,7,0], [-1,4,7,0]],
    'A#': [[0,1,0,1], [0,1,3,1], [3,1,0,1]],
    'B': [[1,2,1,2], [1,2,4,2], [4,2,1,2]],
    'Cm': [[1,3,1,3], [1,3,5,3], [5,3,1,3]],
    'C#m': [[2,4,2,4], [2,4,6,0], [6,4,2,0]],
    'Dm': [[0,0,0,1], [0,0,3,1], [3,0,0,1]],
    'D#m': [[1,1,1,2], [1,1,4,2], [4,1,1,2]],
    'Em': [[2,2,2,3], [2,2,5,0], [5,2,2,0]],
    'Fm': [[3,3,3,4], [3,3,6,4], [6,3,3,4]],
    'F#m': [[4,4,4,5], [4,0,4,2], [4,4,7,5]],
    'Gm': [[0,1,0,3], [0,1,5,3], [5,1,0,3]],
    'G#m': [[1,2,1,4], [-1,2,1,4], [1,2,-1,4]],
    'Am': [[2,3,2,5], [7,0,10,0], [10,0,7,0]],
    'A#m': [[3,4,3,6], [-1,4,3,6], [3,4,-1,6]],
    'Bm': [[0,2,0,2], [0,2,4,2], [4,2,0,2]],
    'C7': [[2,3,5,6], [5,3,2,6], [8,10,10,0]],
    'C#7': [[3,4,6,7], [6,4,3,7], [6,8,9,9]],
    'D7': [[0,0,4,8], [4,0,0,8], [0,3,4,5]],
    'D#7': [[5,6,8,9], [8,6,5,9]],
    'E7': [[0,2,2,4], [0,2,6,0], [2,2,0,4]],
    'F7': [[1,3,3,5], [3,3,1,5]],
    'F#7': [[4,4,8,0], [8,4,4,0], [2,4,4,6]],
    'G7': [[0,2,3,3], [3,2,0,3], [0,2,5,1]],
    'G#7': [[1,3,4,4], [4,3,1,4], [4,6,6,8]],
    'A7': [[5,4,7,0], [7,4,5,0], [2,4,5,5]],
    'A#7': [[0,1,3,4], [3,1,0,4], [0,8,8,4]],
    'B7': [[1,2,4,5], [4,2,1,5], [4,6,7,7]],
    'Cm7': [[5,6,8,8], [8,6,5,8]],
    'C#m7': [[6,7,9,9], [9,7,6,9]],
    'Dm7': [[0,3,3,5], [3,3,0,5], [0,8,7,8]],
    'Em7': [[0,2,2,3], [0,2,5,0], [2,2,0,3]],
    'Fm7': [[1,3,3,4], [3,3,1,4]],
    'F#m7': [[4,4,7,0], [7,4,4,0], [2,4,4,5]],
    'Gm7': [[0,1,3,3], [3,1,0,3], [0,1,5,1]],
    'G#m7': [[1,2,4,4], [4,2,1,4], [4,6,6,7]],
    'Am7': [[5,3,7,0], [7,3,5,0], [2,3,5,5]],
    'A#m7': [[3,4,6,6], [6,4,3,6], [6,8,8,9]],
    'Bm7': [[0,0,4,7], [4,0,0,7], [0,2,4,5]],
    'C6': [[5,3,7,0], [7,3,5,0], [2,3,5,5]],
    'C#6': [[3,4,6,6], [6,4,3,6], [6,8,8,9]],
    'D6': [[0,0,4,7], [4,0,0,7], [0,2,4,5]],
    'D#6': [[5,6,8,8], [8,6,5,8]],
    'E6': [[6,7,9,9], [9,7,6,9]],
    'F6': [[0,3,3,5], [3,3,0,5], [0,8,7,8]],
    'G6': [[0,2,2,3], [0,2,5,0], [2,2,0,3]],
    'G#6': [[1,3,3,4], [3,3,1,4]],
    'A6': [[4,4,7,0], [7,4,4,0], [2,4,4,5]],
    'A#6': [[0,1,3,3], [3,1,0,3], [0,1,5,1]],
    'B6': [[1,2,4,4], [4,2,1,4], [4,6,6,7]],
    'Caug': [[2,3,2,4], [2,3,6,0], [6,3,2,0]],
    'C#aug': [[3,4,3,5], [3,4,7,5], [7,4,3,5]],
    'Daug': [[0,1,0,2], [0,1,4,2], [4,1,0,2]],
    'D#aug': [[1,2,1,3], [1,2,5,3], [5,2,1,3]],
    'Eaug': [[2,3,2,4], [2,3,6,0], [6,3,2,0]],
    'Faug': [[3,4,3,5], [3,0,3,1], [3,4,7,5]],
    'F#aug': [[0,1,0,2], [0,1,4,2], [4,1,0,2]],
    'Gaug': [[1,2,1,3], [1,2,5,3], [5,2,1,3]],
    'G#aug': [[2,3,2,4], [2,3,6,0], [6,3,2,0]],
    'Aaug': [[3,4,3,5], [3,4,7,5], [7,4,3,5]],
    'A#aug': [[0,1,0,2], [0,1,4,2], [4,1,0,2]],
    'Baug': [[1,2,1,3], [1,2,5,3], [5,2,1,3]],
    'Cdim': [[1,3,1,2], [1,3,4,2], [4,3,1,2]],
    'C#dim': [[2,4,2,3], [2,4,5,0], [5,4,2,0]],
    'Ddim': [[0,8,0,4], [0,5,3,4], [3,5,0,4]],
    'D#dim': [[1,0,1,2], [1,0,4,2], [4,0,1,2]],
    'Edim': [[2,1,2,3], [2,1,5,0], [5,1,2,0]],
    'Fdim': [[3,2,3,4], [3,2,6,4], [6,2,3,4]],
    'F#dim': [[4,0,4,8], [4,3,4,5], [4,0,7,8]],
    'Gdim': [[5,4,5,6], [5,4,8,6], [8,4,5,6]],
    'G#dim': [[0,2,0,4], [0,2,6,4], [6,2,0,4]],
    'Adim': [[1,3,1,5], [-1,3,1,5], [1,3,-1,5]],
    'A#dim': [[2,4,2,6], [8,4,8,0], [-1,4,8,0]],
    'Bdim': [[0,2,0,1], [0,2,3,1], [3,2,0,1]],
  },

// Open D: A-D-F#-A-D
// Strings shown: D-F#-A-D
  'Open D': {
    'C': [[2,1,3,2], [2,1,3,5], [5,1,3,2]], 'C#': [[3,2,4,3], [3,2,4,6], [6,2,4,3]],
    'D': [[0,0,0,0], [0,0,0,4], [4,0,0,0]], 'D#': [[1,1,1,1], [1,1,1,5], [5,1,1,1]],
    'E': [[2,2,2,2], [2,2,2,6], [6,2,2,2]], 'F': [[3,3,3,3], [3,6,0,3], [3,3,3,7]],
    'F#': [[4,0,4,8], [4,4,4,4], [8,0,4,4]], 'G': [[0,1,2,0], [0,1,2,5], [5,1,2,0]],
    'G#': [[1,2,3,1], [-1,2,3,1], [1,2,3,-1]], 'A': [[2,3,4,2], [-1,3,4,2], [2,3,4,-1]],
    'A#': [[0,4,1,3], [3,4,1,0], [0,4,8,0]], 'B': [[1,0,2,1], [1,0,2,4], [4,0,2,1]],
    'Cm': [[1,1,3,1], [1,1,3,5], [5,1,3,1]], 'C#m': [[2,2,4,2], [2,2,4,6], [6,2,4,2]],
    'Dm': [[0,3,0,3], [3,3,0,0], [0,3,5,3]], 'D#m': [[1,0,1,1], [1,0,1,4], [4,0,1,1]],
    'Em': [[2,1,2,2], [2,1,2,5], [5,1,2,2]], 'Fm': [[3,2,3,3], [3,2,3,6], [6,2,3,3]],
    'F#m': [[4,0,4,7], [4,3,4,4], [4,7,0,4]], 'Gm': [[0,1,1,0], [0,1,1,5], [5,1,1,0]],
    'G#m': [[1,2,2,1], [-1,2,2,1], [1,2,2,-1]], 'Am': [[2,3,3,2], [2,6,0,2], [-1,3,3,2]],
    'A#m': [[3,4,4,3], [-1,4,4,3], [3,4,4,-1]], 'Bm': [[0,0,2,0], [0,0,2,4], [4,0,2,0]],
    'C7': [[2,4,3,5], [5,4,3,2]], 'C#7': [[3,5,4,6], [6,5,4,3]],
    'D7': [[0,0,0,10], [10,0,0,0], [0,0,3,7]], 'D#7': [[1,4,4,5], [5,4,4,1]],
    'E7': [[0,2,2,2], [2,2,2,0]], 'F7': [[1,3,3,3], [3,3,3,1]],
    'F#7': [[2,4,4,4], [4,4,4,2]], 'G7': [[0,1,2,3], [3,1,2,0]],
    'G#7': [[1,2,3,4], [4,2,3,1]], 'A7': [[2,3,4,5], [5,3,4,2]],
    'A#7': [[0,2,1,3], [3,2,1,0]], 'B7': [[1,3,2,4], [4,3,2,1]],
    'Cm7': [[1,4,3,5], [5,4,3,1]], 'C#m7': [[2,5,4,6], [6,5,4,2]],
    'Dm7': [[0,3,3,3], [3,3,3,0]], 'D#m7': [[1,4,4,4], [4,4,4,1]],
    'Em7': [[0,1,2,2], [2,1,2,0]], 'Fm7': [[1,2,3,3], [3,2,3,1]],
    'F#m7': [[2,3,4,4], [4,3,4,2]], 'Gm7': [[0,1,1,3], [3,1,1,0]],
    'G#m7': [[1,2,2,4], [4,2,2,1]], 'Am7': [[2,3,3,5], [5,3,3,2]],
    'A#m7': [[3,4,4,6], [6,4,4,3]], 'Bm7': [[0,0,0,9], [9,0,0,0], [0,3,2,4]],
    'C6': [[2,3,3,5], [5,3,3,2]], 'C#6': [[3,4,4,6], [6,4,4,3]],
    'D6': [[0,0,0,9], [9,0,0,0], [0,3,2,4]], 'D#6': [[1,4,3,5], [5,4,3,1]],
    'E6': [[2,5,4,6], [6,5,4,2]], 'F6': [[0,3,3,3], [3,3,3,0]],
    'F#6': [[1,4,4,4], [4,4,4,1]], 'G6': [[0,1,2,2], [2,1,2,0]],
    'G#6': [[1,2,3,3], [3,2,3,1]], 'A6': [[2,3,4,4], [4,3,4,2]],
    'A#6': [[0,1,1,3], [3,1,1,0]], 'B6': [[1,2,2,4], [4,2,2,1]],
    'Caug': [[2,2,3,2], [2,2,3,6]], 'C#aug': [[3,3,4,3], [3,7,0,3]],
    'Daug': [[0,0,1,0], [0,0,1,4]], 'D#aug': [[1,1,2,1], [1,1,2,5]],
    'Eaug': [[2,2,3,2], [2,2,3,6]], 'Faug': [[3,3,4,3], [3,7,0,3]],
    'F#aug': [[0,0,1,0], [0,0,1,4]], 'Gaug': [[1,1,2,1], [1,1,2,5]],
    'G#aug': [[2,2,3,2], [2,2,3,6]], 'Aaug': [[3,3,4,3], [3,7,0,3]],
    'A#aug': [[0,0,1,0], [0,0,1,4]], 'Baug': [[1,1,2,1], [1,1,2,5]],
    'Cdim': [[1,0,3,1], [1,0,3,4]], 'C#dim': [[2,1,4,2], [2,1,4,5]],
    'Ddim': [[0,2,5,3], [3,2,5,0]], 'D#dim': [[1,0,0,1], [1,0,0,4]],
    'Edim': [[2,1,1,2], [2,1,1,5]], 'Fdim': [[3,2,2,3], [3,2,2,6]],
    'F#dim': [[4,0,3,7], [4,3,3,4]], 'Gdim': [[5,4,4,5], [5,4,4,8]],
    'G#dim': [[0,2,2,0], [0,2,2,6]], 'Adim': [[1,3,3,1], [-1,3,3,1]],
    'A#dim': [[2,4,4,2], [-1,4,4,2]], 'Bdim': [[0,5,2,3], [3,5,2,0]],
  },

// Double D: A-D-A-D-F#
// Strings shown: D-A-D-F#
  'Double D': {
    'C': [[2,3,2,1], [2,3,5,1], [5,3,2,1]], 'C#': [[3,4,3,2], [3,4,6,2], [6,4,3,2]],
    'D': [[0,0,0,0], [0,0,4,0], [4,0,0,0]], 'D#': [[1,1,1,1], [1,1,5,1], [5,1,1,1]],
    'E': [[2,2,2,2], [2,2,6,2], [6,2,2,2]], 'F': [[3,0,3,6], [3,3,3,3], [3,0,7,6]],
    'F#': [[4,4,4,4], [4,4,8,0], [8,4,4,0]], 'G': [[0,2,0,1], [0,2,5,1], [5,2,0,1]],
    'G#': [[1,3,1,2], [-1,3,1,2], [1,3,-1,2]], 'A': [[2,4,2,3], [-1,4,2,3], [2,4,-1,3]],
    'A#': [[0,1,3,4], [3,1,0,4]], 'B': [[1,2,1,0], [1,2,4,0], [4,2,1,0]],
    'Cm': [[1,3,1,1], [1,3,5,1], [5,3,1,1]], 'C#m': [[2,4,2,2], [2,4,6,2], [6,4,2,2]],
    'Dm': [[0,0,3,3], [3,0,0,3]], 'D#m': [[1,1,1,0], [1,1,4,0], [4,1,1,0]],
    'Em': [[2,2,2,1], [2,2,5,1], [5,2,2,1]], 'Fm': [[3,3,3,2], [3,3,6,2], [6,3,3,2]],
    'F#m': [[4,0,4,7], [4,4,4,3], [4,4,7,0]], 'Gm': [[0,1,0,1], [0,1,5,1], [5,1,0,1]],
    'G#m': [[1,2,1,2], [-1,2,1,2], [1,2,-1,2]], 'Am': [[2,0,2,6], [2,3,2,3]],
    'A#m': [[3,4,3,4], [-1,4,3,4]], 'Bm': [[0,2,0,0], [0,2,4,0], [4,2,0,0]],
    'C7': [[2,3,5,4], [5,3,2,4]], 'C#7': [[3,4,6,5], [6,4,3,5]],
    'D7': [[0,0,10,0], [10,0,0,0], [0,0,4,6]], 'D#7': [[1,4,5,4], [5,4,1,4]],
    'E7': [[0,2,2,2], [2,2,0,2]], 'F7': [[1,3,3,3], [3,3,1,3]],
    'F#7': [[2,4,4,4], [4,4,2,4]], 'G7': [[0,2,3,1], [3,2,0,1]],
    'G#7': [[1,3,4,2], [4,3,1,2]], 'A7': [[2,4,5,3], [5,4,2,3]],
    'A#7': [[0,1,3,2], [3,1,0,2]], 'B7': [[1,0,4,5], [1,2,4,3], [4,0,1,5]],
    'Cm7': [[1,3,5,4], [5,3,1,4]], 'C#m7': [[2,4,6,5], [6,4,2,5]],
    'Dm7': [[0,0,3,6], [0,3,3,3], [3,0,0,6]], 'D#m7': [[1,4,4,4], [4,4,1,4]],
    'Em7': [[0,2,2,1], [2,2,0,1]], 'Fm7': [[1,3,3,2], [3,3,1,2]],
    'F#m7': [[2,4,4,3], [4,4,2,3]], 'Gm7': [[0,1,3,1], [3,1,0,1]],
    'G#m7': [[1,2,4,2], [4,2,1,2]], 'Am7': [[2,0,5,6], [2,3,5,3], [5,0,2,6]],
    'A#m7': [[3,4,6,4], [6,4,3,4]], 'Bm7': [[0,0,9,0], [9,0,0,0], [0,0,4,5]],
    'C6': [[2,0,5,6], [2,3,5,3], [5,0,2,6]], 'C#6': [[3,4,6,4], [6,4,3,4]],
    'D6': [[0,0,9,0], [9,0,0,0], [0,0,4,5]], 'D#6': [[1,3,5,4], [5,3,1,4]],
    'E6': [[2,4,6,5], [6,4,2,5]], 'F6': [[0,0,3,6], [0,3,3,3], [3,0,0,6]],
    'F#6': [[1,4,4,4], [4,4,1,4]], 'G6': [[0,2,2,1], [2,2,0,1]],
    'G#6': [[1,3,3,2], [3,3,1,2]], 'A6': [[2,4,4,3], [4,4,2,3]],
    'A#6': [[0,1,3,1], [3,1,0,1]], 'B6': [[1,2,4,2], [4,2,1,2]],
    'Caug': [[2,3,2,2], [2,3,6,2]], 'C#aug': [[3,0,3,7], [3,4,3,3]],
    'Daug': [[0,1,0,0], [0,1,4,0]], 'D#aug': [[1,2,1,1], [1,2,5,1]],
    'Eaug': [[2,3,2,2], [2,3,6,2]], 'Faug': [[3,0,3,7], [3,4,3,3]],
    'F#aug': [[0,1,0,0], [0,1,4,0]], 'Gaug': [[1,2,1,1], [1,2,5,1]],
    'G#aug': [[2,3,2,2], [2,3,6,2]], 'Aaug': [[3,0,3,7], [3,4,3,3]],
    'A#aug': [[0,1,0,0], [0,1,4,0]], 'Baug': [[1,2,1,1], [1,2,5,1]],
    'Cdim': [[1,3,1,0], [1,3,4,0]], 'C#dim': [[2,4,2,1], [2,4,5,1]],
    'Ddim': [[0,5,3,2], [3,5,0,2]], 'D#dim': [[1,0,1,0], [1,0,4,0]],
    'Edim': [[2,1,2,1], [2,1,5,1]], 'Fdim': [[3,2,3,2], [3,2,6,2]],
    'F#dim': [[4,0,4,6], [4,3,4,3]], 'Gdim': [[5,4,5,4], [5,4,8,4]],
    'G#dim': [[0,2,0,2], [0,2,6,2]], 'Adim': [[1,3,1,3], [-1,3,1,3]],
    'A#dim': [[2,4,2,4], [-1,4,2,4]], 'Bdim': [[0,2,3,5], [3,2,0,5]],
  },

// Open C: G-C-G-C-E
// Strings shown: C-G-C-E
  'Open C': {
    'C': [[0,0,0,0], [0,0,4,0], [4,0,0,0]], 'C#': [[1,1,1,1], [1,1,5,1], [5,1,1,1]],
    'D': [[2,2,2,2], [2,2,6,2], [6,2,2,2]], 'D#': [[3,0,3,6], [3,3,3,3]],
    'E': [[4,4,4,4], [4,4,8,0], [8,4,4,0]], 'F': [[0,2,0,1], [0,2,5,1], [5,2,0,1]],
    'F#': [[1,3,1,2], [-1,3,1,2]], 'G': [[2,4,2,3], [-1,4,2,3]],
    'G#': [[0,1,3,4], [3,1,0,4]], 'A': [[1,2,1,0], [1,2,4,0], [4,2,1,0]],
    'A#': [[2,3,2,1], [2,3,5,1], [5,3,2,1]], 'B': [[3,4,3,2], [3,4,6,2], [6,4,3,2]],
    'Cm': [[0,0,3,3], [3,0,0,3]], 'C#m': [[1,1,1,0], [1,1,4,0], [4,1,1,0]],
    'Dm': [[2,2,2,1], [2,2,5,1], [5,2,2,1]], 'D#m': [[3,3,3,2], [3,3,6,2], [6,3,3,2]],
    'Em': [[4,0,4,7], [4,4,4,3], [4,4,7,0]], 'Fm': [[0,1,0,1], [0,1,5,1], [5,1,0,1]],
    'F#m': [[1,2,1,2], [-1,2,1,2]], 'Gm': [[2,0,2,6], [2,3,2,3]],
    'G#m': [[3,4,3,4], [-1,4,3,4]], 'Am': [[0,2,0,0], [0,2,4,0], [4,2,0,0]],
    'A#m': [[1,3,1,1], [1,3,5,1], [5,3,1,1]], 'Bm': [[2,4,2,2], [2,4,6,2], [6,4,2,2]],
    'C7': [[0,0,10,0], [10,0,0,0], [0,0,4,6]], 'C#7': [[1,4,5,4], [5,4,1,4]],
    'D7': [[0,2,2,2], [2,2,0,2]], 'D#7': [[1,3,3,3], [3,3,1,3]],
    'E7': [[2,4,4,4], [4,4,2,4]], 'F7': [[0,2,3,1], [3,2,0,1]],
    'F#7': [[1,3,4,2], [4,3,1,2]], 'G7': [[2,4,5,3], [5,4,2,3]],
    'G#7': [[0,1,3,2], [3,1,0,2]], 'A7': [[1,0,4,5], [1,2,4,3], [4,0,1,5]],
    'A#7': [[2,3,5,4], [5,3,2,4]], 'B7': [[3,4,6,5], [6,4,3,5]],
    'Cm7': [[0,0,3,6], [0,3,3,3], [3,0,0,6]], 'C#m7': [[1,4,4,4], [4,4,1,4]],
    'Dm7': [[0,2,2,1], [2,2,0,1]], 'D#m7': [[1,3,3,2], [3,3,1,2]],
    'Em7': [[2,4,4,3], [4,4,2,3]], 'Fm7': [[0,1,3,1], [3,1,0,1]],
    'F#m7': [[1,2,4,2], [4,2,1,2]], 'Gm7': [[2,0,5,6], [2,3,5,3], [5,0,2,6]],
    'G#m7': [[3,4,6,4], [6,4,3,4]], 'Am7': [[0,0,9,0], [9,0,0,0], [0,0,4,5]],
    'A#m7': [[1,3,5,4], [5,3,1,4]], 'Bm7': [[2,4,6,5], [6,4,2,5]],
    'C6': [[0,0,9,0], [9,0,0,0], [0,0,4,5]], 'C#6': [[1,3,5,4], [5,3,1,4]],
    'D6': [[2,4,6,5], [6,4,2,5]], 'D#6': [[0,0,3,6], [0,3,3,3], [3,0,0,6]],
    'E6': [[1,4,4,4], [4,4,1,4]], 'F6': [[0,2,2,1], [2,2,0,1]],
    'F#6': [[1,3,3,2], [3,3,1,2]], 'G6': [[2,4,4,3], [4,4,2,3]],
    'G#6': [[0,1,3,1], [3,1,0,1]], 'A6': [[1,2,4,2], [4,2,1,2]],
    'A#6': [[2,0,5,6], [2,3,5,3], [5,0,2,6]], 'B6': [[3,4,6,4], [6,4,3,4]],
    'Caug': [[0,1,0,0], [0,1,4,0]], 'C#aug': [[1,2,1,1], [1,2,5,1]],
    'Daug': [[2,3,2,2], [2,3,6,2]], 'D#aug': [[3,0,3,7], [3,4,3,3]],
    'Eaug': [[0,1,0,0], [0,1,4,0]], 'Faug': [[1,2,1,1], [1,2,5,1]],
    'F#aug': [[2,3,2,2], [2,3,6,2]], 'Gaug': [[3,0,3,7], [3,4,3,3]],
    'G#aug': [[0,1,0,0], [0,1,4,0]], 'Aaug': [[1,2,1,1], [1,2,5,1]],
    'A#aug': [[2,3,2,2], [2,3,6,2]], 'Baug': [[3,0,3,7], [3,4,3,3]],
    'Cdim': [[0,5,3,2], [3,5,0,2]], 'C#dim': [[1,0,1,0], [1,0,4,0]],
    'Ddim': [[2,1,2,1], [2,1,5,1]], 'D#dim': [[3,2,3,2], [3,2,6,2]],
    'Edim': [[4,0,4,6], [4,3,4,3]], 'Fdim': [[5,4,5,4], [5,4,8,4]],
    'F#dim': [[0,2,0,2], [0,2,6,2]], 'Gdim': [[1,3,1,3], [-1,3,1,3]],
    'G#dim': [[2,4,2,4], [-1,4,2,4]], 'Adim': [[0,2,3,5], [3,2,0,5]],
    'A#dim': [[1,3,1,0], [1,3,4,0]], 'Bdim': [[2,4,2,1], [2,4,5,1]],
  },

// G Modal (Sawmill): G-D-G-C-D
// Strings shown: D-G-C-D
  'G Modal (Sawmill)': {
    'C': [[2,0,0,2], [2,0,0,5], [5,0,0,2]], 'C#': [[3,1,1,3], [-1,1,1,3]],
    'D': [[0,2,2,4], [0,2,6,0], [4,2,2,0]], 'D#': [[1,3,3,5], [5,3,3,1]],
    'E': [[2,4,4,6], [6,4,4,2]], 'F': [[3,2,0,3], [3,5,0,7], [7,5,0,3]],
    'F#': [[4,3,1,4], [-1,3,1,4]], 'G': [[0,4,7,0], [0,4,2,5], [5,4,2,0]],
    'G#': [[1,1,0,1], [-1,1,0,1]], 'A': [[2,2,1,2], [-1,2,1,2]],
    'A#': [[0,3,2,3], [0,3,5,0], [3,3,2,0]], 'B': [[1,4,3,4], [4,4,3,1], [4,4,3,4]],
    'Cm': [[1,0,0,1], [1,0,0,5], [5,0,0,1]], 'C#m': [[2,1,1,2], [-1,1,1,2]],
    'Dm': [[0,2,2,3], [0,2,5,0], [3,2,2,0]], 'D#m': [[1,3,3,4], [4,3,3,1]],
    'Em': [[2,4,4,5], [5,4,4,2]], 'Fm': [[3,1,0,3], [3,5,0,6], [6,5,0,3]],
    'F#m': [[4,2,1,4], [-1,2,1,4]], 'Gm': [[0,0,10,0], [0,3,7,0], [0,3,2,5]],
    'G#m': [[6,4,3,6], [-1,4,3,6]], 'Am': [[2,2,0,2], [-1,2,0,2]],
    'A#m': [[3,3,1,3], [-1,3,1,3]], 'Bm': [[0,4,2,4], [0,4,6,0], [4,4,2,0]],
    'C7': [[2,3,0,5], [5,3,0,2]], 'C#7': [[6,6,5,9], [9,6,5,6]],
    'D7': [[0,2,0,4], [4,2,0,0]], 'D#7': [[1,3,1,5], [5,3,1,1]],
    'E7': [[0,4,4,6], [6,4,4,0], [2,4,2,6]], 'F7': [[1,2,0,3], [3,2,0,1]],
    'F#7': [[2,3,1,4], [4,3,1,2]], 'G7': [[0,0,5,9], [0,4,7,3], [3,4,7,0]],
    'G#7': [[1,1,0,4], [4,1,0,1]], 'A7': [[2,2,1,5], [5,2,1,2]],
    'A#7': [[0,3,5,6], [3,3,2,6], [6,3,2,3]], 'B7': [[4,4,3,7], [7,4,3,4]],
    'Cm7': [[1,3,0,5], [5,3,0,1]], 'Dm7': [[0,2,0,3], [3,2,0,0]],
    'D#m7': [[1,3,1,4], [4,3,1,1]], 'Em7': [[0,4,4,5], [5,4,4,0], [2,4,2,5]],
    'Fm7': [[1,1,0,3], [3,1,0,1]], 'F#m7': [[2,2,1,4], [4,2,1,2]],
    'Gm7': [[0,0,5,8], [0,3,7,3], [3,3,7,0]], 'G#m7': [[4,4,3,6], [6,4,3,4]],
    'Am7': [[2,2,0,5], [5,2,0,2]], 'A#m7': [[6,6,5,8], [8,6,5,6]],
    'Bm7': [[0,4,6,7], [7,4,6,0]],
    'C6': [[2,2,0,5], [5,2,0,2]], 'C#6': [[6,6,5,8], [8,6,5,6]],
    'D6': [[0,4,6,7], [7,4,6,0]], 'D#6': [[1,3,0,5], [5,3,0,1]],
    'F6': [[0,2,0,3], [3,2,0,0]], 'F#6': [[1,3,1,4], [4,3,1,1]],
    'G6': [[0,4,4,5], [5,4,4,0], [2,4,2,5]], 'G#6': [[1,1,0,3], [3,1,0,1]],
    'A6': [[2,2,1,4], [4,2,1,2]], 'A#6': [[0,0,5,8], [0,3,7,3], [3,3,7,0]],
    'B6': [[4,4,3,6], [6,4,3,4]],
    'Caug': [[2,1,0,2], [2,5,0,6], [6,5,0,2]], 'C#aug': [[3,2,1,3], [-1,2,1,3]],
    'Daug': [[0,3,2,4], [0,3,6,0], [4,3,2,0]], 'D#aug': [[1,4,3,5], [5,4,3,1]],
    'Eaug': [[2,1,0,2], [2,5,0,6], [6,5,0,2]], 'Faug': [[3,2,1,3], [-1,2,1,3]],
    'F#aug': [[0,3,2,4], [0,3,6,0], [4,3,2,0]], 'Gaug': [[1,4,3,5], [5,4,3,1]],
    'G#aug': [[2,1,0,2], [2,5,0,6], [6,5,0,2]], 'Aaug': [[3,2,1,3], [-1,2,1,3]],
    'A#aug': [[0,3,2,4], [0,3,6,0], [4,3,2,0]], 'Baug': [[1,4,3,5], [5,4,3,1]],
    'Cdim': [[1,5,0,4], [4,5,0,1]], 'C#dim': [[2,0,1,2], [2,0,1,5], [5,0,1,2]],
    'Ddim': [[0,1,2,3], [0,1,5,0], [3,1,2,0]], 'D#dim': [[1,2,3,4], [4,2,3,1]],
    'Edim': [[2,3,4,5], [5,3,4,2]], 'Fdim': [[3,4,5,6], [6,4,5,3]],
    'F#dim': [[4,2,0,4], [4,5,0,7], [7,5,0,4]], 'Gdim': [[5,3,1,5], [-1,3,1,5]],
    'G#dim': [[0,4,8,0], [0,4,2,6], [6,4,2,0]], 'Adim': [[1,2,0,1], [-1,2,0,1]],
    'A#dim': [[2,3,1,2], [-1,3,1,2]], 'Bdim': [[0,4,2,3], [0,4,5,0], [3,4,2,0]],
  },

// Open A: A-E-A-C#-E
// Strings shown: E-A-C#-E
  'Open A': {
    'C': [[0,3,3,3], [0,3,6,0], [3,3,3,0]], 'C#': [[1,4,0,4], [4,4,0,1]],
    'D': [[2,0,1,2], [2,0,1,5], [5,0,1,2]], 'D#': [[3,1,2,3], [6,6,2,3]],
    'E': [[0,2,3,4], [4,2,3,0], [4,2,3,4]], 'F': [[1,3,4,5], [5,3,4,1]],
    'F#': [[2,1,0,2], [2,4,0,6], [6,4,0,2]], 'G': [[3,2,1,3], [-1,2,1,3]],
    'G#': [[4,3,2,4], [-1,3,2,4]], 'A': [[0,0,0,0], [0,0,0,5], [5,0,0,0]],
    'A#': [[1,1,1,1], [-1,1,1,1]], 'B': [[2,2,2,2], [-1,2,2,2]],
    'Cm': [[3,3,2,3], [-1,3,2,3]], 'C#m': [[0,4,0,4], [4,4,0,0], [0,4,3,4]],
    'Dm': [[1,0,1,1], [1,0,1,5], [5,0,1,1]], 'D#m': [[2,1,2,2], [6,6,2,2]],
    'Em': [[0,2,3,3], [0,2,6,0], [3,2,3,0]], 'Fm': [[1,3,4,4], [4,3,4,1]],
    'F#m': [[2,0,0,2], [2,0,0,5], [5,0,0,2]], 'Gm': [[3,1,1,3], [-1,1,1,3]],
    'G#m': [[4,2,2,4], [-1,2,2,4]], 'Am': [[0,3,3,5], [5,3,3,0]],
    'A#m': [[1,1,0,1], [-1,1,0,1]], 'Bm': [[2,2,1,2], [-1,2,1,2]],
    'C7': [[0,3,6,6], [3,3,3,6], [6,3,3,3]], 'C#7': [[1,2,0,4], [4,2,0,1]],
    'D7': [[2,3,1,5], [5,3,1,2]], 'D#7': [[3,4,2,6], [6,4,2,3]],
    'E7': [[0,2,1,4], [4,2,1,0]], 'F7': [[1,3,2,5], [5,3,2,1]],
    'F#7': [[0,1,0,2], [2,1,0,0]], 'G7': [[1,2,1,3], [3,2,1,1]],
    'G#7': [[2,3,2,4], [4,3,2,2]], 'A7': [[0,0,0,3], [3,0,0,0]],
    'A#7': [[1,1,1,4], [4,1,1,1]], 'B7': [[2,2,2,5], [5,2,2,2]],
    'Cm7': [[3,3,2,6], [6,3,2,3]], 'C#m7': [[0,2,0,4], [4,2,0,0]],
    'Dm7': [[1,3,1,5], [5,3,1,1]], 'D#m7': [[2,4,2,6], [6,4,2,2]],
    'Em7': [[0,2,1,3], [3,2,1,0]], 'Fm7': [[1,3,2,4], [4,3,2,1]],
    'F#m7': [[0,0,0,2], [2,0,0,0]], 'Gm7': [[1,1,1,3], [3,1,1,1]],
    'G#m7': [[2,2,2,4], [4,2,2,2]], 'Am7': [[0,0,6,8], [8,0,6,0], [0,3,6,5]],
    'A#m7': [[1,1,0,4], [4,1,0,1]], 'Bm7': [[2,2,1,5], [5,2,1,2]],
    'C6': [[0,0,6,8], [8,0,6,0], [0,3,6,5]], 'C#6': [[1,1,0,4], [4,1,0,1]],
    'D6': [[2,2,1,5], [5,2,1,2]], 'D#6': [[3,3,2,6], [6,3,2,3]],
    'E6': [[0,2,0,4], [4,2,0,0]], 'F6': [[1,3,1,5], [5,3,1,1]],
    'F#6': [[2,4,2,6], [6,4,2,2]], 'G6': [[0,2,1,3], [3,2,1,0]],
    'G#6': [[1,3,2,4], [4,3,2,1]], 'A6': [[0,0,0,2], [2,0,0,0]],
    'A#6': [[1,1,1,3], [3,1,1,1]], 'B6': [[2,2,2,4], [4,2,2,2]],
    'Caug': [[0,3,3,4], [0,3,7,0], [4,3,3,0]], 'C#aug': [[1,0,0,1], [1,0,0,5]],
    'Daug': [[2,1,1,2], [-1,1,1,2]], 'D#aug': [[3,2,2,3], [-1,2,2,3]],
    'Eaug': [[0,3,3,4], [0,3,7,0], [4,3,3,0]], 'Faug': [[1,0,0,1], [1,0,0,5]],
    'F#aug': [[2,1,1,2], [-1,1,1,2]], 'Gaug': [[3,2,2,3], [-1,2,2,3]],
    'G#aug': [[0,3,3,4], [0,3,7,0]], 'Aaug': [[1,0,0,1], [1,0,0,5]],
    'A#aug': [[2,1,1,2], [-1,1,1,2]], 'Baug': [[3,2,2,3], [-1,2,2,3]],
    'Cdim': [[2,3,2,2], [-1,3,2,2]], 'C#dim': [[0,4,0,3], [3,4,0,0]],
    'Ddim': [[1,5,1,4], [4,5,1,1]], 'D#dim': [[2,0,2,2], [2,0,2,5]],
    'Edim': [[0,1,3,3], [3,1,3,0]], 'Fdim': [[1,2,4,4], [4,2,4,1]],
    'F#dim': [[2,3,5,5], [5,3,5,2]], 'Gdim': [[3,1,0,3], [3,4,0,6], [6,4,0,3]],
    'G#dim': [[4,2,1,4], [-1,2,1,4]], 'Adim': [[5,3,2,5], [-1,3,2,5]],
    'A#dim': [[0,1,0,0], [0,4,0,6]], 'Bdim': [[1,2,1,1], [-1,2,1,1]],
  },
};

// ─── Helper Functions ────────────────────────────────────────────────────────

function normalizeNote(note) {
  if (!note) return null;
  let n = note.trim();
  n = n.charAt(0).toUpperCase() + n.slice(1).toLowerCase();
  if (ENHARMONIC_MAP[n]) n = ENHARMONIC_MAP[n];
  return NOTES.includes(n) ? n : null;
}

function noteToSemitone(note) {
  const n = normalizeNote(note);
  return n ? NOTES.indexOf(n) : -1;
}

function semitoneToNote(semitone) {
  return NOTES[((semitone % 12) + 12) % 12];
}

function getChordIntervals(type) {
  switch (type) {
    case 'Major':         return [0, 4, 7];
    case 'Minor':         return [0, 3, 7];
    case 'Seventh':       return [0, 4, 7, 10];
    case 'Minor Seventh': return [0, 3, 7, 10];
    case 'Sixth':         return [0, 4, 7, 9];
    case 'Augmented':     return [0, 4, 8];
    case 'Diminished':    return [0, 3, 6];
    default: return [0, 4, 7];
  }
}

function getChordNotes(root, type) {
  const rootSemitone = noteToSemitone(root);
  if (rootSemitone < 0) return [];
  return getChordIntervals(type).map(i => semitoneToNote(rootSemitone + i));
}

function isOpenG(tuning) {
  const og = ['G', 'D', 'G', 'B', 'D'];
  return tuning.length === 5 && tuning.every((n, i) => normalizeNote(n) === og[i]);
}

// ─── Brute-Force Voicing Finder ──────────────────────────────────────────────

function findAllChordVoicings(root, typeName, tuning) {
  const chordNotes = getChordNotes(root, typeName);
  if (chordNotes.length === 0) return [];

  const intervals = getChordIntervals(typeName);
  const rootSemitone = noteToSemitone(root);
  const thirdSemitone = (rootSemitone + intervals[1]) % 12;
  const chordSemitones = new Set(chordNotes.map(n => noteToSemitone(n)));
  const is4Note = chordNotes.length === 4;

  // Strings 1-4 (excluding drone string 0)
  const stringTunings = tuning.slice(1).map(n => noteToSemitone(n));

  // For each string, precompute which frets produce chord tones
  // Fret values: -1 (mute), 0-10
  const options = [];
  for (let s = 0; s < 4; s++) {
    const validFrets = [-1]; // mute is always an option
    for (let fret = 0; fret <= 10; fret++) {
      if (chordSemitones.has((stringTunings[s] + fret) % 12)) {
        validFrets.push(fret);
      }
    }
    options.push(validFrets);
  }

  const results = [];
  const seen = new Set();

  // Exhaustive search over all valid fret combinations
  for (const f0 of options[0]) {
    for (const f1 of options[1]) {
      for (const f2 of options[2]) {
        for (const f3 of options[3]) {
          const frets = [f0, f1, f2, f3];

          // Count played strings and collect sounded notes
          const played = new Set();
          let numPlayed = 0;
          for (let i = 0; i < 4; i++) {
            if (frets[i] >= 0) {
              played.add((stringTunings[i] + frets[i]) % 12);
              numPlayed++;
            }
          }

          // Must play at least 3 strings
          if (numPlayed < 3) continue;

          // Must include root and third
          if (!played.has(rootSemitone)) continue;
          if (!played.has(thirdSemitone)) continue;

          // For 4-note chords (7ths, m7, 6th), require all notes
          if (is4Note && played.size < 4) continue;

          // Check hand span of fretted (non-open) positions
          const fretted = frets.filter(f => f > 0);
          if (fretted.length > 1) {
            const span = Math.max(...fretted) - Math.min(...fretted);
            if (span > 4) continue;
          }

          // Deduplicate
          const key = frets.join(',');
          if (seen.has(key)) continue;
          seen.add(key);

          // Score the voicing for playability
          let score = 0;
          frets.forEach(f => {
            if (f === 0) score += 12;        // open strings are great
            else if (f > 0 && f <= 4) score += 8 - f;  // low frets preferred
            else if (f > 4) score -= (f - 4); // penalize high frets
            if (f === -1) score -= 10;        // penalize muted strings
          });
          // Bonus for including all chord tones
          if ([...chordSemitones].every(s => played.has(s))) score += 20;
          // Bonus for more strings played
          score += numPlayed * 3;

          results.push({ frets: [...frets], score });
        }
      }
    }
  }

  // Sort by score descending, take top 5
  results.sort((a, b) => b.score - a.score);
  return results.slice(0, 5).map(v => v.frets);
}

// ─── Chord Diagram Component ─────────────────────────────────────────────────

function ChordDiagram({ name, frets, voicingIndex, voicingCount, onNextVoicing, tuningLabels }) {
  const numFrets = 5;
  const frettedPositions = frets.filter(f => f > 0);
  const maxFret = frettedPositions.length > 0 ? Math.max(...frettedPositions) : 0;
  const minFret = frettedPositions.length > 0 ? Math.min(...frettedPositions) : 0;

  let startFret = 0;
  if (maxFret > numFrets) {
    startFret = Math.max(1, minFret - 1);
  }

  const isNut = startFret === 0;

  // SVG dimensions
  const w = 90;
  const h = 130;
  const topPad = 28;
  const botPad = 18;
  const leftPad = 18;
  const rightPad = 10;
  const gridW = w - leftPad - rightPad;
  const gridH = h - topPad - botPad;
  const stringSpacing = gridW / 3;
  const fretSpacing = gridH / numFrets;

  const stringX = (s) => leftPad + s * stringSpacing;
  const fretY = (f) => topPad + f * fretSpacing;

  return (
    <div className="flex flex-col items-center" style={{ width: 110, flexShrink: 0, marginBottom: 8 }}>
      {/* Chord name */}
      <div style={{
        fontFamily: "Georgia, 'Times New Roman', serif",
        fontSize: 18,
        fontWeight: 600,
        color: '#1a1a1a',
        marginBottom: 2,
        letterSpacing: '0.02em',
        lineHeight: 1,
      }}>
        {name}
      </div>

      {/* Voicing button */}
      {voicingCount > 1 ? (
        <button
          onClick={onNextVoicing}
          data-print-hide=""
          style={{
            fontSize: 11,
            color: '#3a3a3a',
            background: '#ecf2e8',
            border: '1px solid #b8c9ab',
            borderRadius: 4,
            padding: '1px 8px',
            cursor: 'pointer',
            marginBottom: 0,
            fontFamily: "'IBM Plex Mono', monospace",
          }}
        >
          {voicingIndex + 1}/{voicingCount}
        </button>
      ) : (
        <div style={{ height: 20 }} />
      )}

      <svg width={w} height={h} viewBox={`0 0 ${w} ${h}`}>
        {/* String markers (O, X) */}
        {frets.map((f, s) => {
          if (f === 0) {
            return (
              <text key={`m${s}`} x={stringX(s)} y={topPad - 6} textAnchor="middle"
                style={{ fontSize: 11, fontFamily: "'IBM Plex Mono', monospace", fill: '#4a7c59' }}>
                O
              </text>
            );
          }
          if (f === -1) {
            return (
              <text key={`m${s}`} x={stringX(s)} y={topPad - 6} textAnchor="middle"
                style={{ fontSize: 11, fontFamily: "'IBM Plex Mono', monospace", fill: '#9a3a3a' }}>
                X
              </text>
            );
          }
          return null;
        })}

        {/* Nut or fret indicator */}
        {isNut ? (
          <line x1={leftPad - 4} y1={topPad} x2={leftPad + gridW + 4} y2={topPad}
            stroke="#1a1a1a" strokeWidth={3} strokeLinecap="round" />
        ) : (
          <text x={leftPad - 12} y={fretY(1) - 2} textAnchor="middle"
            style={{ fontSize: 10, fontFamily: "'IBM Plex Mono', monospace", fill: '#555555' }}>
            {startFret + 1}
          </text>
        )}

        {/* Fret lines */}
        {Array.from({ length: numFrets + 1 }, (_, i) => (
          <line key={`f${i}`}
            x1={leftPad - 2} y1={fretY(i)}
            x2={leftPad + gridW + 2} y2={fretY(i)}
            stroke={i === 0 && !isNut ? '#666666' : '#808080'}
            strokeWidth={i === 0 && !isNut ? 1.5 : 1}
          />
        ))}

        {/* String lines */}
        {[0, 1, 2, 3].map(s => (
          <line key={`s${s}`}
            x1={stringX(s)} y1={topPad}
            x2={stringX(s)} y2={topPad + gridH}
            stroke="#666666" strokeWidth={1}
          />
        ))}

        {/* Finger dots */}
        {frets.map((f, s) => {
          if (f <= 0) return null;
          const displayFret = f - startFret;
          if (displayFret < 1 || displayFret > numFrets) return null;
          return (
            <circle key={`d${s}`}
              cx={stringX(s)}
              cy={fretY(displayFret) - fretSpacing / 2}
              r={7}
              fill="#1a1a1a"
            />
          );
        })}

        {/* String labels */}
        {tuningLabels.map((note, s) => (
          <text key={`l${s}`} x={stringX(s)} y={h - 3} textAnchor="middle"
            style={{ fontSize: 9, fontFamily: "'IBM Plex Mono', monospace", fill: '#555555' }}>
            {note}
          </text>
        ))}
      </svg>
    </div>
  );
}

// ─── Main App Component ──────────────────────────────────────────────────────

export default function BanjoChordChart() {
  const [mode, setMode] = useState('charts'); // 'charts' or 'finder'
  const [selectedTuning, setSelectedTuning] = useState('Open G (Standard)');
  const [customTuning, setCustomTuning] = useState(['G', 'D', 'G', 'B', 'D']);
  const [isCustom, setIsCustom] = useState(false);
  const [voicingSelections, setVoicingSelections] = useState({});

  // Chord Finder state
  const [finderRoot, setFinderRoot] = useState('G');
  const [finderType, setFinderType] = useState('Major');
  const [finderVoicings, setFinderVoicings] = useState({}); // keyed by tuning name

  const currentTuning = isCustom ? customTuning : COMMON_TUNINGS[selectedTuning];
  const tuningLabels = currentTuning.slice(1); // exclude drone for display

  // Determine which library to use (if any)
  const presetLibrary = useMemo(() => {
    if (isOpenG(currentTuning)) return OPEN_G_LIBRARY;
    // Check if this tuning matches a preset library
    if (!isCustom && PRESET_LIBRARIES[selectedTuning]) {
      return PRESET_LIBRARIES[selectedTuning];
    }
    // For custom tunings, also check if they happen to match a known tuning
    for (const [name, notes] of Object.entries(COMMON_TUNINGS)) {
      if (notes.every((n, i) => normalizeNote(currentTuning[i]) === n)) {
        if (name === 'Open G (Standard)') return OPEN_G_LIBRARY;
        if (PRESET_LIBRARIES[name]) return PRESET_LIBRARIES[name];
      }
    }
    return null; // no preset — will use algorithm
  }, [currentTuning.join(','), isCustom, selectedTuning]);

  // Cache algorithmic voicings (only computed for truly custom tunings)
  const algorithmicCache = useMemo(() => {
    if (presetLibrary) return {};
    const cache = {};
    for (const { name: typeName, suffix } of CHORD_TYPES) {
      for (const root of NOTES) {
        const chordName = root + suffix;
        const voicings = findAllChordVoicings(root, typeName, currentTuning);
        if (voicings.length > 0) {
          cache[chordName] = voicings;
        }
      }
    }
    return cache;
  }, [currentTuning.join(','), presetLibrary]);

  const getVoicings = useCallback((chordName) => {
    if (presetLibrary) {
      return presetLibrary[chordName] || [];
    }
    return algorithmicCache[chordName] || [];
  }, [presetLibrary, algorithmicCache]);

  const getSelectedVoicing = useCallback((chordName) => {
    const voicings = getVoicings(chordName);
    if (voicings.length === 0) return null;
    const idx = (voicingSelections[chordName] || 0) % voicings.length;
    return { frets: voicings[idx], index: idx, count: voicings.length };
  }, [getVoicings, voicingSelections]);

  const nextVoicing = (chordName) => {
    setVoicingSelections(prev => ({
      ...prev,
      [chordName]: ((prev[chordName] || 0) + 1),
    }));
  };

  // ─── Chord Finder helpers ───
  const finderSuffix = CHORD_TYPES.find(t => t.name === finderType)?.suffix ?? '';
  const finderChordName = finderRoot + finderSuffix;

  const finderResults = useMemo(() => {
    const results = [];
    // All preset tunings
    const allTunings = { 'Open G (Standard)': COMMON_TUNINGS['Open G (Standard)'], ...Object.fromEntries(
      Object.entries(COMMON_TUNINGS).filter(([k]) => k !== 'Open G (Standard)')
    )};

    for (const [tuningName, tuningNotes] of Object.entries(allTunings)) {
      let library;
      if (isOpenG(tuningNotes)) {
        library = OPEN_G_LIBRARY;
      } else if (PRESET_LIBRARIES[tuningName]) {
        library = PRESET_LIBRARIES[tuningName];
      } else {
        library = null;
      }

      let voicings;
      if (library && library[finderChordName]) {
        voicings = library[finderChordName];
      } else {
        voicings = findAllChordVoicings(finderRoot, finderType, tuningNotes);
      }

      if (voicings.length > 0) {
        results.push({
          tuningName,
          tuningNotes,
          tuningLabels: tuningNotes.slice(1),
          voicings,
        });
      }
    }
    return results;
  }, [finderRoot, finderType, finderChordName]);

  const nextFinderVoicing = (tuningName) => {
    setFinderVoicings(prev => ({
      ...prev,
      [tuningName]: ((prev[tuningName] || 0) + 1),
    }));
  };

  const getFinderVoicing = (tuningName, voicings) => {
    const idx = (finderVoicings[tuningName] || 0) % voicings.length;
    return { frets: voicings[idx], index: idx, count: voicings.length };
  };

  const handleTuningChange = (name) => {
    setSelectedTuning(name);
    setIsCustom(false);
    setVoicingSelections({});
  };

  const handleCustomNote = (index, value) => {
    const newTuning = [...customTuning];
    const normalized = normalizeNote(value);
    newTuning[index] = normalized || value.toUpperCase().slice(0, 2);
    setCustomTuning(newTuning);
    setVoicingSelections({});
  };

  // Determine the tuning display name
  const tuningDisplayName = isCustom
    ? `Custom Tuning: ${currentTuning.join('-')}`
    : `${selectedTuning}: ${currentTuning.join('-')}`;

  return (
    <div style={{
      fontFamily: "Georgia, 'Times New Roman', serif",
      background: 'linear-gradient(168deg, #f4f7f2 0%, #e8efe4 50%, #d8e4d2 100%)',
      minHeight: '100vh',
      color: '#1a1a1a',
    }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?IBM+Plex+Mono:wght@400;500&family=Crimson+Pro:wght@300;400;600&display=swap');
      `}</style>

      {/* ─── Header ─── */}
      <header data-print-hide="" style={{
        padding: '32px 24px 20px',
        textAlign: 'center',
        borderBottom: '1px solid #b8c9ab',
      }}>
        <h1 style={{
          fontSize: 32,
          fontWeight: 400,
          letterSpacing: '0.03em',
          margin: 0,
          color: '#1a1a1a',
          fontFamily: "Georgia, 'Times New Roman', serif",
        }}>
          Banjo Chord Helper
        </h1>
        <p style={{
          fontFamily: "'Crimson Pro', Georgia, serif",
          fontSize: 15,
          color: '#555555',
          marginTop: 6,
          fontWeight: 300,
          letterSpacing: '0.04em',
        }}>
          Five-string chord diagrams for any tuning
        </p>

        {/* Mode toggle */}
        <div style={{
          display: 'flex',
          justifyContent: 'center',
          gap: 4,
          marginTop: 16,
        }}>
          {[['charts', 'Chord Charts'], ['finder', 'Chord Finder']].map(([key, label]) => (
            <button
              key={key}
              onClick={() => setMode(key)}
              style={{
                padding: '7px 20px',
                border: '1px solid #a8bb9a',
                borderRadius: 6,
                background: mode === key ? '#2a2a2a' : 'rgba(255,255,255,0.5)',
                color: mode === key ? '#f4f7f2' : '#3a3a3a',
                fontFamily: "'Crimson Pro', Georgia, serif",
                fontSize: 14,
                fontWeight: mode === key ? 600 : 400,
                cursor: 'pointer',
                letterSpacing: '0.03em',
                transition: 'all 0.15s ease',
              }}
            >
              {label}
            </button>
          ))}
        </div>
      </header>

      {/* ─── CHORD CHARTS MODE ─── */}
      {mode === 'charts' && (
        <>
      <h2 style={{
        fontFamily: "Georgia, 'Times New Roman', serif",
        fontSize: 22,
        fontWeight: 400,
        textAlign: 'center',
        color: '#2a2a2a',
        margin: '20px 0 0',
        letterSpacing: '0.03em',
      }}>
        Banjo Chord Charts
      </h2>
      <p style={{
        fontFamily: "'Crimson Pro', Georgia, serif",
        fontSize: 14,
        color: '#555555',
        textAlign: 'center',
        margin: '4px 0 0',
        fontWeight: 300,
      }}>
        {tuningDisplayName}
      </p>
      {/* ─── Tuning Selector ─── */}
      <div data-print-hide="" style={{
        padding: '20px 24px',
        maxWidth: 700,
        margin: '0 auto',
      }}>
        <div style={{
          background: 'rgba(255,255,255,0.45)',
          border: '1px solid #b8c9ab',
          borderRadius: 8,
          padding: '18px 22px',
        }}>
          <div style={{
            display: 'flex',
            gap: 20,
            marginBottom: 14,
            fontFamily: "'Crimson Pro', Georgia, serif",
            fontSize: 15,
          }}>
            <label style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6 }}>
              <input type="radio" checked={!isCustom} onChange={() => setIsCustom(false)}
                style={{ accentColor: '#3a3a3a' }} />
              Common Tunings
            </label>
            <label style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6 }}>
              <input type="radio" checked={isCustom} onChange={() => setIsCustom(true)}
                style={{ accentColor: '#3a3a3a' }} />
              Custom Tuning
            </label>
          </div>

          {!isCustom ? (
            <select
              value={selectedTuning}
              onChange={(e) => handleTuningChange(e.target.value)}
              style={{
                width: '100%',
                padding: '8px 12px',
                border: '1px solid #a8bb9a',
                borderRadius: 6,
                background: '#f2f6f0',
                fontFamily: "'IBM Plex Mono', monospace",
                fontSize: 14,
                color: '#1a1a1a',
                cursor: 'pointer',
                outline: 'none',
              }}
            >
              {Object.entries(COMMON_TUNINGS).map(([name, notes]) => (
                <option key={name} value={name}>
                  {name}: {notes.join('-')}
                </option>
              ))}
            </select>
          ) : (
            <div>
              <div style={{
                fontFamily: "'IBM Plex Mono', monospace",
                fontSize: 11,
                color: '#555555',
                marginBottom: 6,
              }}>
                5th (drone) → 1st string
              </div>
              <div style={{ display: 'flex', gap: 8 }}>
                {customTuning.map((note, i) => (
                  <input
                    key={i}
                    type="text"
                    value={note}
                    maxLength={2}
                    onChange={(e) => handleCustomNote(i, e.target.value)}
                    style={{
                      width: 48,
                      padding: '8px 6px',
                      textAlign: 'center',
                      border: '1px solid #a8bb9a',
                      borderRadius: 6,
                      background: '#f2f6f0',
                      fontFamily: "'IBM Plex Mono', monospace",
                      fontSize: 15,
                      color: '#1a1a1a',
                      outline: 'none',
                    }}
                    placeholder={['5th', '4th', '3rd', '2nd', '1st'][i]}
                  />
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Download PDF */}
        <div style={{ textAlign: 'center', marginTop: 12 }}>
          <button
            onClick={async () => {
              // Load jspdf from CDN
              if (!window.jspdf) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(script);
                await new Promise((res, rej) => { script.onload = res; script.onerror = rej; });
              }
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
              const pageW = doc.internal.pageSize.getWidth();
              const pageH = doc.internal.pageSize.getHeight();
              const margin = 40;
              const footerY = pageH - 25;
              const contentBottom = footerY - 10; // stop content before footer

              // Footer drawing function
              const drawFooter = (pageNum) => {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Page ${pageNum}`, margin, footerY);
                doc.text('Banjo Chord Helper', pageW / 2, footerY, { align: 'center' });
                doc.text('Created by Ukecurious', pageW - margin, footerY, { align: 'right' });
                doc.text('Find Ukecurious at https://linktr.ee/ukecurious', pageW / 2, footerY + 12, { align: 'center' });
                doc.setTextColor(0);
              };

              let pageNum = 1;

              // Title
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(18);
              doc.text('Banjo Chord Charts', pageW / 2, margin, { align: 'center' });
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(11);
              doc.text(tuningDisplayName, pageW / 2, margin + 18, { align: 'center' });

              let curY = margin + 42;

              // Chord diagram dimensions
              const dW = 80;   // diagram width
              const dH = 110;  // diagram height
              const nameH = 26; // space for chord name + gap before open string markers
              const cardH = nameH + dH + 6;
              const cardW = dW + 10;
              const cols = Math.floor((pageW - 2 * margin) / cardW);
              const gridStartX = margin + ((pageW - 2 * margin) - cols * cardW) / 2;

              // Drawing function for a single chord diagram
              const drawChord = (x, y, chordName, frets, labels) => {
                // Chord name
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(chordName, x + dW / 2, y + 10, { align: 'center' });

                const gx = x + 12;
                const gy = y + nameH;
                const gw = dW - 24;
                const gh = dH - 20;
                const numFrets = 5;
                const strSpacing = gw / 3;
                const fretSpacing = gh / numFrets;

                const fretted = frets.filter(f => f > 0);
                const maxFret = fretted.length > 0 ? Math.max(...fretted) : 0;
                let startFret = 0;
                if (maxFret > numFrets) {
                  const minFret = Math.min(...fretted);
                  startFret = Math.max(1, minFret - 1);
                }
                const isNut = startFret === 0;

                // Draw strings
                doc.setDrawColor(80);
                doc.setLineWidth(0.5);
                for (let s = 0; s < 4; s++) {
                  const sx = gx + s * strSpacing;
                  doc.line(sx, gy, sx, gy + gh);
                }

                // Draw frets
                for (let f = 0; f <= numFrets; f++) {
                  const fy = gy + f * fretSpacing;
                  doc.setLineWidth(f === 0 && isNut ? 2 : 0.5);
                  doc.line(gx, fy, gx + (3) * strSpacing, fy);
                }

                // Fret position indicator
                if (!isNut) {
                  doc.setFont('helvetica', 'normal');
                  doc.setFontSize(7);
                  doc.text(String(startFret + 1), gx - 8, gy + fretSpacing / 2 + 2);
                }

                // Draw markers
                for (let s = 0; s < 4; s++) {
                  const f = frets[s];
                  const sx = gx + s * strSpacing;
                  if (f === 0) {
                    doc.setDrawColor(80);
                    doc.setLineWidth(0.8);
                    doc.circle(sx, gy - 5, 3);
                  } else if (f === -1) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    doc.text('✕', sx, gy - 3, { align: 'center' });
                  } else {
                    const displayFret = f - startFret;
                    const dotY = gy + displayFret * fretSpacing - fretSpacing / 2;
                    doc.setFillColor(0);
                    doc.circle(sx, dotY, 3.5, 'F');
                  }
                }

                // String labels
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6);
                doc.setTextColor(120);
                for (let s = 0; s < 4; s++) {
                  doc.text(labels[s], gx + s * strSpacing, gy + gh + 10, { align: 'center' });
                }
                doc.setTextColor(0);
              };

              // Iterate chord types
              for (const { name: typeName, suffix } of CHORD_TYPES) {
                const chords = [];
                for (const root of NOTES) {
                  const cn = root + suffix;
                  const v = getSelectedVoicing(cn);
                  if (v) chords.push({ name: cn, frets: v.frets });
                }
                if (chords.length === 0) continue;

                // Section heading — ensure room for heading + at least one row of chords
                if (curY + 26 + cardH > contentBottom) {
                  drawFooter(pageNum);
                  doc.addPage();
                  pageNum++;
                  curY = margin;
                }

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(13);
                doc.text(typeName, margin, curY + 12);
                doc.setDrawColor(150);
                doc.setLineWidth(0.5);
                doc.line(margin, curY + 16, pageW - margin, curY + 16);
                curY += 26;

                // Draw chords in grid
                let col = 0;
                for (const chord of chords) {
                  if (col >= cols) { col = 0; curY += cardH; }
                  if (curY + cardH > contentBottom) {
                    drawFooter(pageNum);
                    doc.addPage();
                    pageNum++;
                    curY = margin;
                    col = 0;
                  }
                  const cx = gridStartX + col * cardW;
                  drawChord(cx, curY, chord.name, chord.frets, tuningLabels);
                  col++;
                }
                curY += cardH + 10;
              }

              // Draw footer on last page
              drawFooter(pageNum);

              const pdfBlob = doc.output('blob');
              const url = URL.createObjectURL(pdfBlob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `banjo-chords-${(isCustom ? currentTuning.join('-') : selectedTuning).replace(/[^a-zA-Z0-9]/g, '-')}.pdf`;
              a.target = '_blank';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              setTimeout(() => URL.revokeObjectURL(url), 5000);
            }}
            style={{
              padding: '6px 18px',
              border: '1px solid #a8bb9a',
              borderRadius: 6,
              background: 'rgba(255,255,255,0.5)',
              color: '#3a3a3a',
              fontFamily: "'Crimson Pro', Georgia, serif",
              fontSize: 13,
              cursor: 'pointer',
              letterSpacing: '0.03em',
            }}
          >
            Download PDF
          </button>
        </div>
      </div>

      {/* ─── Chord Sections ─── */}
      <div data-print-area="" style={{
        padding: '8px 24px 40px',
        maxWidth: 900,
        margin: '0 auto',
      }}>
        {CHORD_TYPES.map(({ name: typeName, suffix }) => {
          const chords = [];
          for (const root of NOTES) {
            const chordName = root + suffix;
            const voicing = getSelectedVoicing(chordName);
            if (voicing) {
              chords.push({ root, chordName, voicing });
            }
          }
          if (chords.length === 0) return null;

          return (
            <section key={typeName} style={{ marginTop: 28 }}>
              <h2 style={{
                fontFamily: "Georgia, 'Times New Roman', serif",
                fontSize: 20,
                fontWeight: 400,
                color: '#2a2a2a',
                borderBottom: '1px solid #b8c9ab',
                paddingBottom: 6,
                marginBottom: 16,
                letterSpacing: '0.03em',
              }}>
                {typeName}
              </h2>
              <div style={{
                display: 'flex',
                flexWrap: 'wrap',
                gap: 8,
                justifyContent: 'flex-start',
              }}>
                {chords.map(({ chordName, voicing }) => (
                  <ChordDiagram
                    key={chordName}
                    name={chordName}
                    frets={voicing.frets}
                    voicingIndex={voicing.index}
                    voicingCount={voicing.count}
                    onNextVoicing={() => nextVoicing(chordName)}
                    tuningLabels={tuningLabels}
                  />
                ))}
              </div>
            </section>
          );
        })}
      </div>
        </>
      )}

      {/* ─── CHORD FINDER MODE ─── */}
      {mode === 'finder' && (
        <>
      <h2 style={{
        fontFamily: "Georgia, 'Times New Roman', serif",
        fontSize: 22,
        fontWeight: 400,
        textAlign: 'center',
        color: '#2a2a2a',
        margin: '20px 0 0',
        letterSpacing: '0.03em',
      }}>
        Banjo Chord Finder
      </h2>
      <div data-print-hide="" style={{
        padding: '20px 24px',
        maxWidth: 700,
        margin: '0 auto',
      }}>
        <div style={{
          background: 'rgba(255,255,255,0.45)',
          border: '1px solid #b8c9ab',
          borderRadius: 8,
          padding: '18px 22px',
        }}>
          <div style={{
            fontFamily: "'Crimson Pro', Georgia, serif",
            fontSize: 14,
            color: '#555555',
            marginBottom: 10,
          }}>
            Select a chord to see how it's played across all tunings
          </div>

          <div style={{ display: 'flex', gap: 12, alignItems: 'center', flexWrap: 'wrap' }}>
            {/* Root note selector */}
            <select
              value={finderRoot}
              onChange={(e) => { setFinderRoot(e.target.value); setFinderVoicings({}); }}
              style={{
                padding: '8px 12px',
                border: '1px solid #a8bb9a',
                borderRadius: 6,
                background: '#f2f6f0',
                fontFamily: "'IBM Plex Mono', monospace",
                fontSize: 16,
                color: '#1a1a1a',
                cursor: 'pointer',
                outline: 'none',
                minWidth: 60,
              }}
            >
              {NOTES.map(n => (
                <option key={n} value={n}>{n}</option>
              ))}
            </select>

            {/* Chord type selector */}
            <select
              value={finderType}
              onChange={(e) => { setFinderType(e.target.value); setFinderVoicings({}); }}
              style={{
                padding: '8px 12px',
                border: '1px solid #a8bb9a',
                borderRadius: 6,
                background: '#f2f6f0',
                fontFamily: "'IBM Plex Mono', monospace",
                fontSize: 14,
                color: '#1a1a1a',
                cursor: 'pointer',
                outline: 'none',
                flex: 1,
                minWidth: 140,
              }}
            >
              {CHORD_TYPES.map(({ name }) => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>

            {/* Display the chord name */}
            <div style={{
              fontFamily: "Georgia, 'Times New Roman', serif",
              fontSize: 28,
              fontWeight: 600,
              color: '#1a1a1a',
              padding: '0 8px',
            }}>
              {finderChordName}
            </div>
          </div>
        </div>
      </div>

      {/* ─── Finder Results ─── */}
      <div style={{
        padding: '8px 24px 40px',
        maxWidth: 900,
        margin: '0 auto',
      }}>
        {finderResults.length === 0 && (
          <p style={{
            textAlign: 'center',
            fontFamily: "'Crimson Pro', Georgia, serif",
            fontSize: 15,
            color: '#777777',
            marginTop: 32,
          }}>
            No playable voicings found for {finderChordName} in any tuning.
          </p>
        )}
        {finderResults.map(({ tuningName, tuningNotes, tuningLabels: tLabels, voicings }) => {
          const v = getFinderVoicing(tuningName, voicings);
          return (
            <div key={tuningName} style={{
              marginTop: 24,
              display: 'flex',
              alignItems: 'flex-start',
              gap: 20,
              padding: '16px 20px',
              background: 'rgba(255,255,255,0.35)',
              border: '1px solid #b8c9ab',
              borderRadius: 8,
            }}>
              {/* Tuning info */}
              <div style={{ minWidth: 160, flexShrink: 0 }}>
                <div style={{
                  fontFamily: "Georgia, 'Times New Roman', serif",
                  fontSize: 17,
                  fontWeight: 400,
                  color: '#2a2a2a',
                  marginBottom: 4,
                }}>
                  {tuningName}
                </div>
                <div style={{
                  fontFamily: "'IBM Plex Mono', monospace",
                  fontSize: 12,
                  color: '#555555',
                }}>
                  {tuningNotes.join('-')}
                </div>
              </div>

              {/* Chord diagram */}
              <ChordDiagram
                name={finderChordName}
                frets={v.frets}
                voicingIndex={v.index}
                voicingCount={v.count}
                onNextVoicing={() => nextFinderVoicing(tuningName)}
                tuningLabels={tLabels}
              />

              {/* Fret numbers text */}
              <div style={{
                fontFamily: "'IBM Plex Mono', monospace",
                fontSize: 13,
                color: '#555555',
                paddingTop: 28,
              }}>
                <div>{v.frets.map(f => f === -1 ? 'X' : f).join('-')}</div>
                <div style={{ color: '#777777', fontSize: 12, marginTop: 3 }}>
                  {v.frets.map((f, i) => {
                    if (f === -1) return 'X';
                    const stringSemitone = noteToSemitone(tLabels[i]);
                    return semitoneToNote(stringSemitone + f);
                  }).join('-')}
                </div>
              </div>
            </div>
          );
        })}
      </div>
        </>
      )}

      {/* ─── Footer ─── */}
      <footer data-print-hide="" style={{
        textAlign: 'center',
        padding: '20px 24px 32px',
        borderTop: '1px solid #b8c9ab',
      }}>
        <p style={{
          fontFamily: "'Crimson Pro', Georgia, serif",
          fontSize: 13,
          color: '#777777',
          fontWeight: 300,
        }}>
          Chord diagrams show strings 4–1 (drone string omitted) · Voicings for custom tunings are algorithmically generated
        </p>
        <p style={{
          fontFamily: "'Crimson Pro', Georgia, serif",
          fontSize: 12,
          color: '#888888',
          fontWeight: 300,
          marginTop: 12,
          lineHeight: 1.6,
        }}>
          This chord chart tool is brought to you by{' '}
          <a href="https://linktr.ee/ukecurious" target="_blank" rel="noopener noreferrer"
            style={{ color: '#555555', textDecoration: 'underline' }}>Ukecurious</a>.
          <br />
          If you want to support my work, you can{' '}
          <a href="https://buymeacoffee.com/ukecurious" target="_blank" rel="noopener noreferrer"
            style={{ color: '#555555', textDecoration: 'underline' }}>buy me a coffee</a>.
        </p>
      </footer>

    </div>
  );
}
